<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Customer Weekly Minutes Tracker — Updated</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data;:">

<style>
    html { min-height: 100%; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f4f9; padding: 20px; margin: 0; min-height: 100vh; }
    .container { max-width: 1000px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    h2 { color: #333; }

    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
    .control-group { display: flex; flex-direction: column; gap: 10px; }
    .controls label { font-weight: 600; color: #555; font-size: 0.9em; }
    input[type="text"], input[type="date"], input[type="time"], select { padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
    button.add-btn { padding: 12px; border: none; background: #4CAF50; color: white; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: auto; }
    button.add-btn:hover { background: #45a049; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #4CAF50; color: white; }

    .customer-link { color: #2196F3; font-weight: bold; text-decoration: underline; cursor: pointer; }
    .customer-link:hover { color: #0b7dda; }

    .view-section { display: none; }
    .active-view { display: block; }

    .back-btn { background: #666; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 15px; }
    .back-btn:hover { background: #555; }

    .delete-btn { background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    .delete-btn:hover { background: #cc0000; }

    .small { font-size: 0.85em; color: #666; }

    @media (max-width: 800px) { .controls { grid-template-columns: 1fr; } }
</style>
</head>

<body>

<div class="container">

    <!-- DASHBOARD -->
    <div id="dashboardView" class="view-section active-view">
        <h2>Weekly Customer Minutes Tracker</h2>

        <div class="controls">
            <div class="control-group">
                <label>Customer Name: <input type="text" id="customer" placeholder="e.g. Greenlands"></label>
                <label>Start Time: <input type="time" id="startTime"></label>
                <label>Finish Time: <input type="time" id="finishTime"></label>
            </div>

            <div class="control-group">
                <label>Worker Names (comma separated): <input type="text" id="workerNames" placeholder="John, Alex, Sarah"></label>
                <label>Date: <input type="date" id="workDate"></label>
                <div style="display:flex;gap:10px;">
                    <button class="add-btn" onclick="addRecord()">Add Entry</button>
                    <button class="add-btn" style="background:#1976d2" onclick="openWorkerTotals()">Worker Totals</button>
                </div>
            </div>
        </div>

        <h3>All Entries</h3>
        <table id="minutesTable">
            <thead>
            <tr>
                <th>Customer</th>
                <th>Total Minutes</th>
                <th>Hours</th>
                <th>Breakdown</th>
                <th>Workers</th>
                <th>Time & Date</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <!-- CUSTOMER VIEW -->
    <div id="customerView" class="view-section">
        <button class="back-btn" onclick="showDashboard()">← Back to Dashboard</button>
        <h2 id="customerTitle">Customer Details</h2>
        <div id="customerTotals" class="small" style="margin-bottom:10px;"></div>
        <table id="customerTable">
            <thead>
            <tr>
                <th>Total Minutes</th>
                <th>Hours</th>
                <th>Breakdown</th>
                <th>Workers</th>
                <th>Time & Date</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <!-- WORKER TOTALS VIEW -->
    <div id="workerView" class="view-section">
        <button class="back-btn" onclick="showDashboard()">← Back to Dashboard</button>
        <h2>Worker Totals</h2>
        <div class="controls" style="grid-template-columns: 1fr 1fr 1fr;">
            <div class="control-group">
                <label>Period:
                    <select id="periodSelect">
                        <option value="day">Day</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                        <option value="year">Year</option>
                    </select>
                </label>
            </div>
            <div class="control-group">
                <label>Reference Date: <input type="date" id="periodDate"></label>
            </div>
            <div class="control-group" style="align-items:flex-end;">
                <button class="add-btn" onclick="showWorkerTotals()">Show Totals</button>
            </div>
        </div>

        <h3>Totals for Selected Period</h3>
        <div id="workerPeriodSummary" class="small" style="margin-bottom:8px;"></div>
        <table id="workerTable">
            <thead>
            <tr>
                <th>Worker</th>
                <th>Total Minutes</th>
                <th>Hours</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script>
    // Global store
    let allRecords = [];

    // Default date input to today
    document.getElementById('workDate').valueAsDate = new Date();

    function calculateMinutes(start, finish) {
        const [sh, sm] = start.split(":").map(Number);
        const [fh, fm] = finish.split(":").map(Number);
        const startDate = new Date(0,0,0,sh,sm);
        const finishDate = new Date(0,0,0,fh,fm);
        let diff = (finishDate - startDate) / 60000;
        if (diff < 0) diff += 1440; // crossing midnight
        return diff;
    }

    function addRecord() {
        const customer = document.getElementById("customer").value.trim();
        const workerNamesStr = document.getElementById("workerNames").value.trim();
        const start = document.getElementById("startTime").value;
        const finish = document.getElementById("finishTime").value;
        const date = document.getElementById("workDate").value;

        if (!customer || !workerNamesStr || !start || !finish || !date) {
            alert("Please complete all fields.");
            return;
        }

        const nameList = workerNamesStr.split(",").map(n => n.trim()).filter(n => n.length > 0);
        if (nameList.length === 0) { alert("Please enter at least one worker name."); return; }

        const workersCount = nameList.length;
        const minutes = calculateMinutes(start, finish); // minutes per worker
        const total = minutes * workersCount; // total minutes across all workers
        const breakdown = `${workersCount} worker(s) × ${minutes} mins`;

        // Create structured record for easier filtering/sorting
        const newRecord = {
            id: Date.now(),
            customer: customer,
            minutesPerWorker: minutes, // integer
            workersCount: workersCount,
            total: total, // minutes across all workers
            breakdown: breakdown,
            workers: nameList, // array
            startTime: start,
            finishTime: finish,
            date: date, // YYYY-MM-DD
            // display timestamp
            timeStamp: `${start} to ${finish} | ${date}`
        };

        // Add to data store
        allRecords.push(newRecord);

        // Render
        renderMainTable();

        // Clear fields (except date)
        document.getElementById("customer").value = "";
        document.getElementById("workerNames").value = "";
    }

    // Utility: convert record to Date object using date + finishTime for ordering
    function recordDateTime(record) {
        // Use date + finishTime to represent when the entry finished (keeps ordering intuitive)
        return new Date(record.date + 'T' + record.finishTime);
    }

    // Sort records newest first (top) — newest at top, oldest at bottom
    function sortedRecordsDesc(records) {
        return records.slice().sort((a,b) => recordDateTime(b) - recordDateTime(a));
    }

    function renderMainTable() {
        const tbody = document.querySelector("#minutesTable tbody");
        tbody.innerHTML = "";

        const sorted = sortedRecordsDesc(allRecords);

        sorted.forEach(record => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><span class="customer-link" onclick="openCustomerPage('${escapeHtml(record.customer)}')">${escapeHtml(record.customer)}</span></td>
                <td>${record.total}</td>
                <td>${(record.total/60).toFixed(2)}</td>
                <td>${escapeHtml(record.breakdown)}</td>
                <td>${escapeHtml(record.workers.join(', '))}</td>
                <td>${escapeHtml(record.timeStamp)}</td>
                <td><button class="delete-btn" onclick="deleteRecord(${record.id})">Delete</button></td>
            `;
        });
    }

    function deleteRecord(id) {
        if (confirm('Are you sure you want to delete this entry?')) {
            allRecords = allRecords.filter(r => r.id !== id);
            renderMainTable();
        }
    }

    // --- Customer Page ---
    function openCustomerPage(customerName) {
        document.getElementById('dashboardView').classList.remove('active-view');
        document.getElementById('workerView').classList.remove('active-view');
        document.getElementById('customerView').classList.add('active-view');

        document.getElementById('customerTitle').innerText = `Records for: ${customerName}`;

        const customerRecords = allRecords.filter(r => r.customer === customerName);
        const tbody = document.querySelector('#customerTable tbody');
        tbody.innerHTML = '';

        if (customerRecords.length === 0) {
            document.getElementById('customerTotals').innerText = '';
            tbody.innerHTML = "<tr><td colspan='5'>No records found.</td></tr>";
            return;
        }

        // Sort newest first
        const sorted = sortedRecordsDesc(customerRecords);

        // Compute totals for this customer: total minutes across all workers, and hours
        const totalMinutesAll = sorted.reduce((s,r) => s + r.total, 0);
        const totalHours = (totalMinutesAll / 60);
        document.getElementById('customerTotals').innerText = `Total: ${totalMinutesAll} minutes (${totalHours.toFixed(2)} hours)`;

        sorted.forEach(record => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${record.total}</td>
                <td>${(record.total/60).toFixed(2)}</td>
                <td>${escapeHtml(record.breakdown)}</td>
                <td>${escapeHtml(record.workers.join(', '))}</td>
                <td>${escapeHtml(record.timeStamp)}</td>
            `;
        });
    }

    function showDashboard() {
        document.getElementById('customerView').classList.remove('active-view');
        document.getElementById('workerView').classList.remove('active-view');
        document.getElementById('dashboardView').classList.add('active-view');
    }

    // --- Worker Totals View ---
    function openWorkerTotals() {
        // Set defaults: period = week, date = latest record date or today
        document.getElementById('dashboardView').classList.remove('active-view');
        document.getElementById('customerView').classList.remove('active-view');
        document.getElementById('workerView').classList.add('active-view');

        document.getElementById('periodSelect').value = 'week';

        if (allRecords.length > 0) {
            // latest entered date (max by date)
            const latest = allRecords.reduce((a,b) => (a.date > b.date ? a : b));
            document.getElementById('periodDate').value = latest.date;
        } else {
            document.getElementById('periodDate').valueAsDate = new Date();
        }

        showWorkerTotals();
    }

    function showWorkerTotals() {
        const period = document.getElementById('periodSelect').value;
        const refDateStr = document.getElementById('periodDate').value;
        if (!refDateStr) { alert('Please select a reference date'); return; }

        const ref = new Date(refDateStr + 'T00:00:00');
        let start, end;

        if (period === 'day') {
            start = new Date(ref);
            end = new Date(ref);
            end.setHours(23,59,59,999);
        } else if (period === 'week') {
            // week: Monday - Sunday
            const day = (ref.getDay() + 6) % 7; // 0=Monday
            start = new Date(ref);
            start.setDate(ref.getDate() - day);
            start.setHours(0,0,0,0);
            end = new Date(start);
            end.setDate(start.getDate() + 6);
            end.setHours(23,59,59,999);
        } else if (period === 'month') {
            start = new Date(ref.getFullYear(), ref.getMonth(), 1);
            end = new Date(ref.getFullYear(), ref.getMonth()+1, 0, 23,59,59,999);
        } else { // year
            start = new Date(ref.getFullYear(), 0, 1);
            end = new Date(ref.getFullYear(), 11, 31, 23,59,59,999);
        }

        // Filter records within [start,end]
        const filtered = allRecords.filter(r => {
            const rDate = new Date(r.date + 'T00:00:00');
            return rDate >= start && rDate <= end;
        });

        // Compute totals per worker. For each record, each worker gets minutesPerWorker.
        const totals = {}; // name -> minutes
        filtered.forEach(r => {
            r.workers.forEach(name => {
                if (!totals[name]) totals[name] = 0;
                totals[name] += r.minutesPerWorker; // add minutes per worker
            });
        });

        // Render
        const tbody = document.querySelector('#workerTable tbody');
        tbody.innerHTML = '';

        const entries = Object.keys(totals).map(name => ({ name, minutes: totals[name]}));
        // sort by minutes desc
        entries.sort((a,b) => b.minutes - a.minutes);

        if (entries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3">No data for selected period.</td></tr>';
        } else {
            entries.forEach(e => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${escapeHtml(e.name)}</td>
                    <td>${e.minutes}</td>
                    <td>${(e.minutes/60).toFixed(2)}</td>
                `;
            });
        }

        // Summary text
        document.getElementById('workerPeriodSummary').innerText = `Showing ${filtered.length} entries between ${formatDate(start)} and ${formatDate(end)}.`;
    }

    // Helpers
    function formatDate(d) {
        return d.toISOString().slice(0,10);
    }

    // Very small escape to avoid breaking HTML when names contain quotes
    function escapeHtml(str) {
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/'/g, "&#39;").replace(/\"/g, '&quot;');
    }

    // Expose initial render
    renderMainTable();

</script>

</body>
</html>
